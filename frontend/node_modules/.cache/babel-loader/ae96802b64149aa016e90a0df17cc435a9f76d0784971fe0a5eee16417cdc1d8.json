{"ast":null,"code":"var _jsxFileName = \"/Users/guillaumebrousset/Documents/STUDI/billeterie_jo/frontend/src/pages/CheckoutPage.js\",\n  _s = $RefreshSig$();\nimport React, { useState } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport axios from 'axios';\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst CheckoutPage = () => {\n  _s();\n  const location = useLocation(); // On récupère les données du panier\n  //const navigate = useNavigate();\n  const {\n    selectedOffers\n  } = location.state || {\n    selectedOffers: []\n  };\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [paymentStatus, setPaymentStatus] = useState(null);\n  const totalAmount = selectedOffers.reduce((total, offer) => total + parseFloat(offer.price), 0);\n\n  // Fonction pour simuler la finalisation de l'achat\n  const handlePayment = async () => {\n    if (isProcessing || selectedOffers.length === 0) return; // Vérifiez également si les offres sont vides\n\n    setIsProcessing(true); // Désactiver le bouton immédiatement\n    setPaymentStatus(null); // Réinitialiser le statut de paiement\n\n    // Obtenir l'ID de l'utilisateur et le token du localStorage\n    const userId = localStorage.getItem('userId');\n    const token = localStorage.getItem('token');\n\n    // Ajoute un log pour vérifier si userId est bien récupéré\n    console.log('userId:', userId);\n\n    // Temporisation de 3 secondes avant de simuler le paiement\n    await new Promise(resolve => setTimeout(resolve, 3000)); // 3000 ms = 3 secondes\n\n    const isSuccess = Math.random() > 0.05; // Simuler 95% de réussite\n\n    if (isSuccess) {\n      try {\n        // Mettre à jour la quantité d'offres vendues\n        const offerPromises = selectedOffers.map(offer => axios.put(`http://localhost:3001/api/offers/${offer.offer_id}/purchase`, {\n          quantity: 1\n        }, {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        }));\n        await Promise.all(offerPromises);\n\n        // Créer les billets\n        const ticketPromises = selectedOffers.map(offer => axios.post('http://localhost:3001/api/tickets', {\n          offer_id: offer.offer_id,\n          purchase_amount: offer.price\n        }, {\n          headers: {\n            'Authorization': `Bearer ${token}`\n          }\n        }));\n        const ticketResponses = await Promise.all(ticketPromises);\n\n        // Créer les paiements\n        const paymentPromises = ticketResponses.map(ticket => {\n          console.log('Payment data:', {\n            user_id: userId,\n            ticket_id: ticket.data.ticket_id,\n            amount: ticket.data.purchase_amount,\n            status: 'réussi'\n          });\n          return axios.post('http://localhost:3001/api/payments/create', {\n            user_id: userId,\n            // Ajoute ici le user_id\n            ticket_id: ticket.data.ticket_id,\n            amount: ticket.data.purchase_amount,\n            status: 'réussi'\n          }, {\n            headers: {\n              'Authorization': `Bearer ${token}`\n            }\n          });\n        });\n        await Promise.all(paymentPromises);\n        console.log('Paiement réussi et billets créés !');\n        setPaymentStatus('success'); // Paiement réussi\n      } catch (error) {\n        console.error('Erreur lors de la création du paiement ou de la mise à jour de l\\'offre:', error);\n        setPaymentStatus('failed'); // Paiement échoué\n      }\n    } else {\n      console.log('Échec simulé du paiement.');\n      setPaymentStatus('failed'); // Simuler un échec de paiement\n    }\n    setIsProcessing(false); // Réinitialiser après le traitement\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"checkout-page\",\n    children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n      children: \"R\\xE9capitulatif de la commande\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 101,\n      columnNumber: 13\n    }, this), selectedOffers.length > 0 ? /*#__PURE__*/_jsxDEV(_Fragment, {\n      children: [selectedOffers.map(offer => /*#__PURE__*/_jsxDEV(\"div\", {\n        children: /*#__PURE__*/_jsxDEV(\"p\", {\n          children: [offer.offer_name, \" - \", offer.price, \" \\u20AC\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 106,\n          columnNumber: 29\n        }, this)\n      }, offer.offer_id, false, {\n        fileName: _jsxFileName,\n        lineNumber: 105,\n        columnNumber: 25\n      }, this)), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"total-amount\",\n        children: /*#__PURE__*/_jsxDEV(\"h3\", {\n          children: [\"Total: \", totalAmount.toFixed(2), \" \\u20AC\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 110,\n          columnNumber: 25\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 109,\n        columnNumber: 21\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: handlePayment,\n        className: \"finalize-payment-button\",\n        disabled: isProcessing // Désactiver le bouton si le paiement est en cours\n        ,\n        children: isProcessing ? 'Traitement en cours...' : 'Finaliser le paiement'\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 112,\n        columnNumber: 21\n      }, this)]\n    }, void 0, true) : /*#__PURE__*/_jsxDEV(\"p\", {\n      children: \"Votre panier est vide.\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 121,\n      columnNumber: 17\n    }, this), paymentStatus === 'success' && /*#__PURE__*/_jsxDEV(\"div\", {\n      children: /*#__PURE__*/_jsxDEV(\"h2\", {\n        children: \"Paiement r\\xE9ussi !\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 126,\n        columnNumber: 21\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 125,\n      columnNumber: 17\n    }, this), paymentStatus === 'failed' && /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n        children: \"\\xC9chec du paiement !\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 131,\n        columnNumber: 21\n      }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n        children: \"Une erreur est survenue. Veuillez r\\xE9essayer.\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 132,\n        columnNumber: 21\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 130,\n      columnNumber: 17\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 100,\n    columnNumber: 9\n  }, this);\n};\n_s(CheckoutPage, \"MfQyhHmbG9PaPQFY8SZJKC5LlDU=\", false, function () {\n  return [useLocation];\n});\n_c = CheckoutPage;\nexport default CheckoutPage;\nvar _c;\n$RefreshReg$(_c, \"CheckoutPage\");","map":{"version":3,"names":["React","useState","useLocation","axios","jsxDEV","_jsxDEV","Fragment","_Fragment","CheckoutPage","_s","location","selectedOffers","state","isProcessing","setIsProcessing","paymentStatus","setPaymentStatus","totalAmount","reduce","total","offer","parseFloat","price","handlePayment","length","userId","localStorage","getItem","token","console","log","Promise","resolve","setTimeout","isSuccess","Math","random","offerPromises","map","put","offer_id","quantity","headers","all","ticketPromises","post","purchase_amount","ticketResponses","paymentPromises","ticket","user_id","ticket_id","data","amount","status","error","className","children","fileName","_jsxFileName","lineNumber","columnNumber","offer_name","toFixed","onClick","disabled","_c","$RefreshReg$"],"sources":["/Users/guillaumebrousset/Documents/STUDI/billeterie_jo/frontend/src/pages/CheckoutPage.js"],"sourcesContent":["import React, { useState } from 'react';\nimport { useLocation} from 'react-router-dom';\nimport axios from 'axios';\n\nconst CheckoutPage = () => {\n    const location = useLocation(); // On récupère les données du panier\n    //const navigate = useNavigate();\n    const { selectedOffers } = location.state || { selectedOffers: [] };\n    const [isProcessing, setIsProcessing] = useState(false);\n    const [paymentStatus, setPaymentStatus] = useState(null);\n\n    const totalAmount = selectedOffers.reduce((total, offer) => total + parseFloat(offer.price), 0);\n\n    // Fonction pour simuler la finalisation de l'achat\n    const handlePayment = async () => {\n        if (isProcessing || selectedOffers.length === 0) return; // Vérifiez également si les offres sont vides\n\n        setIsProcessing(true); // Désactiver le bouton immédiatement\n        setPaymentStatus(null); // Réinitialiser le statut de paiement\n\n        // Obtenir l'ID de l'utilisateur et le token du localStorage\n        const userId = localStorage.getItem('userId');\n        const token = localStorage.getItem('token');\n\n        // Ajoute un log pour vérifier si userId est bien récupéré\n        console.log('userId:', userId);\n\n        // Temporisation de 3 secondes avant de simuler le paiement\n        await new Promise((resolve) => setTimeout(resolve, 3000)); // 3000 ms = 3 secondes\n\n        const isSuccess = Math.random() > 0.05; // Simuler 95% de réussite\n\n        if (isSuccess) {\n            try {\n                // Mettre à jour la quantité d'offres vendues\n                const offerPromises = selectedOffers.map(offer => \n                    axios.put(`http://localhost:3001/api/offers/${offer.offer_id}/purchase`, {\n                        quantity: 1,\n                    }, {\n                        headers: {\n                            'Authorization': `Bearer ${token}`, \n                        }\n                    })\n                );\n\n                await Promise.all(offerPromises);\n\n                // Créer les billets\n                const ticketPromises = selectedOffers.map(offer =>\n                    axios.post('http://localhost:3001/api/tickets', {\n                        offer_id: offer.offer_id,\n                        purchase_amount: offer.price,\n                    }, {\n                        headers: {\n                            'Authorization': `Bearer ${token}` \n                        }\n                    })\n                );\n\n                const ticketResponses = await Promise.all(ticketPromises);\n\n                // Créer les paiements\n                const paymentPromises = ticketResponses.map(ticket => {\n                    console.log('Payment data:', {\n                        user_id: userId,\n                        ticket_id: ticket.data.ticket_id,\n                        amount: ticket.data.purchase_amount,\n                        status: 'réussi',\n                    });\n\n                    return axios.post('http://localhost:3001/api/payments/create', {\n                        user_id: userId, // Ajoute ici le user_id\n                        ticket_id: ticket.data.ticket_id,\n                        amount: ticket.data.purchase_amount,\n                        status: 'réussi',\n                    }, {\n                        headers: {\n                            'Authorization': `Bearer ${token}`\n                        }\n                    });\n                });\n\n                await Promise.all(paymentPromises);\n\n                console.log('Paiement réussi et billets créés !');\n                setPaymentStatus('success'); // Paiement réussi\n            } catch (error) {\n                console.error('Erreur lors de la création du paiement ou de la mise à jour de l\\'offre:', error);\n                setPaymentStatus('failed'); // Paiement échoué\n            }\n        } else {\n            console.log('Échec simulé du paiement.');\n            setPaymentStatus('failed'); // Simuler un échec de paiement\n        }\n\n        setIsProcessing(false); // Réinitialiser après le traitement\n    };\n\n    return (\n        <div className=\"checkout-page\">\n            <h1>Récapitulatif de la commande</h1>\n            {selectedOffers.length > 0 ? (\n                <>\n                    {selectedOffers.map(offer => (\n                        <div key={offer.offer_id}>\n                            <p>{offer.offer_name} - {offer.price} €</p>\n                        </div>\n                    ))}\n                    <div className=\"total-amount\">\n                        <h3>Total: {totalAmount.toFixed(2)} €</h3>\n                    </div>\n                    <button\n                        onClick={handlePayment}\n                        className=\"finalize-payment-button\"\n                        disabled={isProcessing} // Désactiver le bouton si le paiement est en cours\n                    >\n                        {isProcessing ? 'Traitement en cours...' : 'Finaliser le paiement'}\n                    </button>\n                </>\n            ) : (\n                <p>Votre panier est vide.</p>\n            )}\n\n            {paymentStatus === 'success' && (\n                <div>\n                    <h2>Paiement réussi !</h2>\n                </div>\n            )}\n            {paymentStatus === 'failed' && (\n                <div>\n                    <h2>Échec du paiement !</h2>\n                    <p>Une erreur est survenue. Veuillez réessayer.</p>\n                </div>\n            )}\n        </div>\n    );\n};\n\nexport default CheckoutPage;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}